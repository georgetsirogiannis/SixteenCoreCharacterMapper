name: Build MacOS and Linux Binaries

on:
  workflow_dispatch:

env:
  # CHANGE THIS VERSION NUMBER FOR EVERY RELEASE
  APP_VERSION: "2.0.0"
  APP_NAME: "16Core Character Mapper"

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Generate .icns Files
        run: |
          create_icns() {
            SOURCE=$1; NAME=$2; mkdir "$NAME.iconset"
            for RES in 16 32 128 256 512; do
              sips -z $RES $RES "$SOURCE" --out "$NAME.iconset/icon_${RES}x${RES}.png"
              sips -z $((RES*2)) $((RES*2)) "$SOURCE" --out "$NAME.iconset/icon_${RES}x${RES}@2x.png"
            done
            iconutil -c icns "$NAME.iconset" && rm -rf "$NAME.iconset"
          }
          create_icns "SixteenCoreCharacterMapper.Avalonia/Assets/16Core Logo v3 Retina.png" "AppIcon"
          create_icns "SixteenCoreCharacterMapper.Avalonia/Assets/16Core File Icon v1 Retina.png" "FileIcon"

      - name: Build & Package DMG (Intel & ARM)
        run: |
          package_dmg() {
            ARCH=$1; OUTPUT_FILENAME=$2
            # Added -p:SupportedOSPlatformVersion=10.15 for compatibility
            dotnet publish SixteenCoreCharacterMapper.Avalonia/SixteenCoreCharacterMapper.Avalonia.csproj \
              -c Release -r $ARCH --self-contained true -p:PublishSingleFile=true \
              -p:SupportedOSPlatformVersion=10.15 --output ./publish-$ARCH
            
            DIR_NAME="${{ env.APP_NAME }}.app"
            mkdir -p "$DIR_NAME/Contents/MacOS"
            mkdir -p "$DIR_NAME/Contents/Resources"
            cp -R ./publish-$ARCH/* "$DIR_NAME/Contents/MacOS/"
            cp AppIcon.icns "$DIR_NAME/Contents/Resources/"
            cp FileIcon.icns "$DIR_NAME/Contents/Resources/"
            cp SixteenCoreCharacterMapper.Avalonia/Info.plist "$DIR_NAME/Contents/Info.plist"
            
            # Find and rename binary
            find "$DIR_NAME/Contents/MacOS" -type f -maxdepth 1 -not -name "*.*" -exec mv {} "$DIR_NAME/Contents/MacOS/${{ env.APP_NAME }}" \;
            chmod +x "$DIR_NAME/Contents/MacOS/${{ env.APP_NAME }}"

            create-dmg \
              --volname "${{ env.APP_NAME }} - v${{ env.APP_VERSION }}" \
              --window-pos 200 120 \
              --window-size 600 400 \
              --icon-size 100 \
              --icon "${{ env.APP_NAME }}.app" 175 190 \
              --hide-extension "${{ env.APP_NAME }}.app" \
              --app-drop-link 425 190 \
              "$OUTPUT_FILENAME" \
              "$DIR_NAME"
          }

          package_dmg "osx-x64" "16Core-v${{ env.APP_VERSION }}-macOS-Intel.dmg"
          package_dmg "osx-arm64" "16Core-v${{ env.APP_VERSION }}-macOS-AppleSilicon.dmg"

      - name: Upload macOS DMGs
        uses: actions/upload-artifact@v4
        with:
          name: 16Core-v${{ env.APP_VERSION }}-macOS-DMGs
          path: "*.dmg"

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Build & Package AppImage
        run: |
          dotnet publish SixteenCoreCharacterMapper.Avalonia/SixteenCoreCharacterMapper.Avalonia.csproj \
            -c Release -r linux-x64 --self-contained true -p:PublishSingleFile=true --output ./publish-linux
          
          mkdir -p AppDir/usr/bin
          cp -R ./publish-linux/* AppDir/usr/bin/
          find AppDir/usr/bin -type f -maxdepth 1 -not -name "*.*" -exec mv {} AppDir/usr/bin/16CoreCharacterMapper \;
          chmod +x AppDir/usr/bin/16CoreCharacterMapper
          
          cat <<EOF > AppDir/16Core.desktop
          [Desktop Entry]
          Name=16Core Character Mapper
          Exec=16CoreCharacterMapper
          Icon=16core
          Type=Application
          Categories=Utility;
          EOF
          
          cp "SixteenCoreCharacterMapper.Avalonia/Assets/16Core Logo v3 Retina.png" AppDir/16core.png
          
          cat <<EOF > AppDir/AppRun
          #!/bin/sh
          cd "\$(dirname "\$0")"
          exec ./usr/bin/16CoreCharacterMapper "\$@"
          EOF
          chmod +x AppDir/AppRun

          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool
          ./appimagetool --appimage-extract
          ARCH=x86_64 ./squashfs-root/AppRun AppDir "16Core-v${{ env.APP_VERSION }}-Linux.AppImage"

      - name: Upload Linux AppImage
        uses: actions/upload-artifact@v4
        with:
          name: 16Core-v${{ env.APP_VERSION }}-Linux-AppImage
          path: "*.AppImage"
