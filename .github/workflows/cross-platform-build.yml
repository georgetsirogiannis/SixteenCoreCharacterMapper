name: Build MacOS and Linux Binaries

on:
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-net@v4
        with:
          dotnet-version: 8.0.x

      - name: Build & Package macOS
        run: |
          # 1. Generate Icons using the specific paths provided
          create_icns() {
            SOURCE=$1; NAME=$2; mkdir "$NAME.iconset"
            for RES in 16 32 128 256 512; do
              sips -z $RES $RES "$SOURCE" --out "$NAME.iconset/icon_${RES}x${RES}.png"
              sips -z $((RES*2)) $((RES*2)) "$SOURCE" --out "$NAME.iconset/icon_${RES}x${RES}@2x.png"
            done
            iconutil -c icns "$NAME.iconset" && rm -rf "$NAME.iconset"
          }
          
          # Target the specific path in your repo
          create_icns "SixteenCoreCharacterMapper.Avalonia/Assets/16Core Logo v3 Retina.png" "AppIcon"
          create_icns "SixteenCoreCharacterMapper.Avalonia/Assets/16Core File Icon v1 Retina.png" "FileIcon"

          # 2. Build for Intel (x64) targeting the Avalonia project specifically
          dotnet publish SixteenCoreCharacterMapper.Avalonia/SixteenCoreCharacterMapper.Avalonia.csproj -c Release -r osx-x64 --self-contained true -p:PublishSingleFile=true --output ./publish-intel
          
          # 3. Build for Apple Silicon (ARM64)
          dotnet publish SixteenCoreCharacterMapper.Avalonia/SixteenCoreCharacterMapper.Avalonia.csproj -c Release -r osx-arm64 --self-contained true -p:PublishSingleFile=true --output ./publish-arm

          # 4. Assemble Intel .app
          mkdir -p "16Core_macOS_Intel.app/Contents/MacOS"
          mkdir -p "16Core_macOS_Intel.app/Contents/Resources"
          cp -R ./publish-intel/* "16Core_macOS_Intel.app/Contents/MacOS/"
          cp AppIcon.icns "16Core_macOS_Intel.app/Contents/Resources/"
          cp FileIcon.icns "16Core_macOS_Intel.app/Contents/Resources/"
          cp SixteenCoreCharacterMapper.Avalonia/Info.plist "16Core_macOS_Intel.app/Contents/Info.plist"
          chmod +x "16Core_macOS_Intel.app/Contents/MacOS/SixteenCoreCharacterMapper.Avalonia"
          zip -r 16Core-macOS-Intel.zip 16Core_macOS_Intel.app

          # 5. Assemble ARM .app
          mkdir -p "16Core_macOS_ARM.app/Contents/MacOS"
          mkdir -p "16Core_macOS_ARM.app/Contents/Resources"
          cp -R ./publish-arm/* "16Core_macOS_ARM.app/Contents/MacOS/"
          cp AppIcon.icns "16Core_macOS_ARM.app/Contents/Resources/"
          cp FileIcon.icns "16Core_macOS_ARM.app/Contents/Resources/"
          cp SixteenCoreCharacterMapper.Avalonia/Info.plist "16Core_macOS_ARM.app/Contents/Info.plist"
          chmod +x "16Core_macOS_ARM.app/Contents/MacOS/SixteenCoreCharacterMapper.Avalonia"
          zip -r 16Core-macOS-AppleSilicon.zip 16Core_macOS_ARM.app

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: 16Core-macOS-Builds
          path: "*.zip"

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-net@v4
        with:
          dotnet-version: 8.0.x
      - name: Build Linux
        run: |
          dotnet publish SixteenCoreCharacterMapper.Avalonia/SixteenCoreCharacterMapper.Avalonia.csproj -c Release -r linux-x64 --self-contained true -p:PublishSingleFile=true --output ./publish-linux
          tar -czvf 16Core-Character-Mapper-Linux.tar.gz -C ./publish-linux .
      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: 16Core-Linux-Build
          path: 16Core-Character-Mapper-Linux.tar.gz
