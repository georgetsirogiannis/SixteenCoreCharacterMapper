name: Build MacOS and Linux Binaries

on:
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-net@v4
        with:
          dotnet-version: 8.0.x

      - name: Install DotNetBundle Tool
        run: dotnet tool install -g DotNetBundle

      - name: Generate .icns Files from Retina PNGs
        run: |
          # Function to convert PNG to ICNS
          create_icns() {
            SOURCE=$1; NAME=$2; mkdir "$NAME.iconset"
            for RES in 16 32 128 256 512; do
              sips -z $RES $RES "$SOURCE" --out "$NAME.iconset/icon_${RES}x${RES}.png"
              sips -z $((RES*2)) $((RES*2)) "$SOURCE" --out "$NAME.iconset/icon_${RES}x${RES}@2x.png"
            done
            iconutil -c icns "$NAME.iconset" && rm -rf "$NAME.iconset"
          }

          # Using your specific Retina PNG paths
          create_icns "SixteenCoreCharacterMapper.Avalonia/Assets/16Core Logo v3 Retina.png" "AppIcon"
          create_icns "SixteenCoreCharacterMapper.Avalonia/Assets/16Core File Icon v1 Retina.png" "FileIcon"

      - name: Build & Bundle macOS (Intel & ARM)
        run: |
          PROJECT_DIR="SixteenCoreCharacterMapper.Avalonia"
          PROJECT_FILE="$PROJECT_DIR/SixteenCoreCharacterMapper.Avalonia.csproj"
          
          # Build both architectures
          dotnet bundle $PROJECT_FILE -c Release -r osx-x64 --self-contained true -p:PublishSingleFile=true
          dotnet bundle $PROJECT_FILE -c Release -r osx-arm64 --self-contained true -p:PublishSingleFile=true
          
          # Inject Icons and Info.plist into the resulting .app folders
          find . -name "*.app" -type d | while read app; do
            cp AppIcon.icns "$app/Contents/Resources/AppIcon.icns"
            cp FileIcon.icns "$app/Contents/Resources/FileIcon.icns"
            cp "$PROJECT_DIR/Info.plist" "$app/Contents/Info.plist"
          done

          # Package them for download
          zip -r 16Core-macOS-Intel.zip $(find . -path "*osx-x64/*.app" -type d)
          zip -r 16Core-macOS-AppleSilicon.zip $(find . -path "*osx-arm64/*.app" -type d)

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: 16Core-macOS-Builds
          path: "*.zip"

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-net@v4
        with:
          dotnet-version: 8.0.x
      - name: Build Linux
        run: |
          PROJECT_FILE="SixteenCoreCharacterMapper.Avalonia/SixteenCoreCharacterMapper.Avalonia.csproj"
          dotnet publish $PROJECT_FILE -c Release -r linux-x64 --self-contained true -p:PublishSingleFile=true
          PUBLISH_DIR=$(find . -path "*/linux-x64/publish" -type d | head -n 1)
          tar -czvf 16Core-Character-Mapper-Linux.tar.gz -C "$PUBLISH_DIR" .
      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: 16Core-Linux-Build
          path: 16Core-Character-Mapper-Linux.tar.gz
